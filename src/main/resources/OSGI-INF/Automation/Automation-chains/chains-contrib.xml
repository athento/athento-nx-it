<?xml version="1.0" encoding="UTF-8"?>

<component name="org.athento.nuxeo.athento-nx-it.chains-sai"
		   version="1.0.0">
	<require>org.nuxeo.runtime.started</require>

	<extension target="org.nuxeo.ecm.core.operation.OperationServiceComponent"
			   point="chains">

		<chain id="sai-assignid">
			<documentation>
				Sequential ID.
				3 characters - SAI
				2 digits - Year
				2 digits - Month
				6 numbers - Sequential ID
				Example:
				SAI-yyMM-xxxxxx
			</documentation>
			<operation id="Context.FetchDocument" />
			<!-- Year. Used for uniqueness of number id AND the composition of the
               id -->
			<operation id="Context.SetVar">
				<param type="string" name="name">year_var</param>
				<param type="object" name="value">expr:new
					java.text.SimpleDateFormat("yy").format(Document["dc:created"].getTime())
				</param>
			</operation>
			<!-- Month. Used for uniqueness of number id AND the composition of the
                id -->
			<operation id="Context.SetVar">
				<param type="string" name="name">month_var</param>
				<param type="object" name="value">expr:new
					java.text.SimpleDateFormat("MM").format(Document["dc:created"].getTime())
				</param>
			</operation>
			<!-- Number, which is formatted with 6 digits -->
			<operation id="Context.SetVar">
				<param type="string" name="name">uniquesainumber_var</param>
				<param type="object" name="value">expr:Fn.getNextId("unique-sai-key"+month_var+year_var)
				</param>
			</operation>
			<operation id="Context.SetVar">
				<param type="string" name="name">uniquesainumberformatted_var</param>
				<param type="object" name="value">expr:uniquesainumber_var.format("%06d",Integer.valueOf(uniquesainumber_var))
				</param>
			</operation>
			<!-- Final variable id_var with the ID composition. Stored in both title -->
			<operation id="Context.SetVar">
				<param type="string" name="name">id_var</param>
				<param type="object" name="value">expr:@{"SAI-"+year_var+month_var+"-"+uniquesainumberformatted_var}
				</param>
			</operation>
			<operation id="Document.SetProperty">
				<param type="string" name="xpath">dc:title</param>
				<param type="boolean" name="save">true</param>
				<param type="serializable" name="value">expr:id_var
				</param>
			</operation>
			<operation id="Document.CheckIn">
				<param type="string" name="version">0.0</param>
			</operation>

		</chain>

	</extension>

</component>